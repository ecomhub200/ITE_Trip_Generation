/**
 * ITE Trip Generation Tool - Export Functions
 * Handles Excel and PDF export functionality
 */

/**
 * Export results to Excel file
 * @param {object} result - The calculation result object
 */
function exportToExcel(result) {
  // Create workbook content
  const date = new Date();
  const dateStr = date.toISOString().split('T')[0];
  const filename = `POD_${dateStr}.xlsx`;

  // Build Excel XML format (simplified xlsx compatible format)
  const xmlContent = generateExcelXML(result, date);

  // Create blob and download
  const blob = new Blob([xmlContent], {
    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  });

  // For better compatibility, use CSV format with proper formatting
  const csvContent = generateCSV(result, date);
  const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

  // Create download link
  const link = document.createElement('a');
  link.href = URL.createObjectURL(csvBlob);
  link.download = `POD_${dateStr}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
}

/**
 * Generate CSV content for export
 */
function generateCSV(result, date) {
  const lines = [];

  // Header section
  lines.push('ITE TRIP GENERATION ANALYSIS REPORT');
  lines.push(`Generated: ${date.toLocaleString()}`);
  lines.push('');

  // Development Information
  lines.push('DEVELOPMENT INFORMATION');
  lines.push(`Parcel ID,${result.parcelId}`);
  if (result.devName) {
    lines.push(`Development Name,${result.devName}`);
  }
  if (result.zoningCode) {
    lines.push(`Zoning Code,${result.zoningCode}`);
  }
  lines.push(`ITE Code,${result.iteCode}`);
  lines.push(`Land Use,${result.landUseName}`);
  lines.push(`Category,${result.category}`);
  lines.push(`Size,${result.size}`);
  lines.push(`Unit,${result.unit}`);
  lines.push(`Location Type,Suburban (Henrico County)`);
  lines.push('');

  // Trip Generation Summary
  lines.push('TRIP GENERATION SUMMARY');
  lines.push('Time Period,Total Trips,Entering,Exiting,Method,Rate');
  lines.push(`Weekday Daily,${result.weekday.trips},${Math.round(result.weekday.trips/2)},${result.weekday.trips - Math.round(result.weekday.trips/2)},${result.weekday.method},${result.weekday.rate}`);
  lines.push(`AM Peak Hour,${result.amPeak.trips},${result.amPeak.entering},${result.amPeak.exiting},${result.amPeak.method},${result.amPeak.rate}`);
  lines.push(`PM Peak Hour,${result.pmPeak.trips},${result.pmPeak.entering},${result.pmPeak.exiting},${result.pmPeak.method},${result.pmPeak.rate}`);
  lines.push('');

  // Directional Splits
  lines.push('DIRECTIONAL SPLITS');
  lines.push('Time Period,% Entering,% Exiting');
  lines.push(`AM Peak,${result.amPeak.enteringPct}%,${result.amPeak.exitingPct}%`);
  lines.push(`PM Peak,${result.pmPeak.enteringPct}%,${result.pmPeak.exitingPct}%`);
  lines.push('');

  // Threshold Analysis
  lines.push('THRESHOLD ANALYSIS');
  lines.push('Threshold,Limit,Actual,Status');
  result.thresholds.details.forEach(d => {
    const actual = d.actual !== undefined ? d.actual : `AM:${d.amPeak} PM:${d.pmPeak}`;
    lines.push(`${d.threshold},${d.value} ${d.unit},${actual},${d.status}`);
  });
  lines.push('');
  lines.push(`Overall Status,${result.thresholds.overallStatus}`);
  lines.push('');

  // Data Quality
  lines.push('DATA QUALITY ASSESSMENT');
  lines.push(`Sample Size,${result.quality.sampleSize} sites,${result.quality.sampleQuality}`);
  lines.push(`R-Squared,${result.quality.rSquared || 'N/A'},${result.quality.correlationQuality}`);
  lines.push(`Confidence Level,${result.quality.confidenceLevel}`);
  lines.push('');

  // Calculation Details
  lines.push('CALCULATION DETAILS');
  lines.push(`Weekday Formula,${result.weekday.formula}`);
  lines.push(`Source,${result.source}`);
  lines.push(`Page Reference,${result.pageRef}`);
  lines.push('');

  // Executive Summary
  lines.push('EXECUTIVE SUMMARY');
  const unitText = result.unit.toLowerCase().includes('dwelling') ?
    `${result.size} residential units` :
    `${result.size} ${result.unit}`;
  const totalIn = Math.round(result.weekday.trips / 2);
  const totalOut = result.weekday.trips - totalIn;
  lines.push(`"For ${result.parcelId}, the following is the approximate number of new trips expected by the proposed development of ${unitText}: Total Weekday trips = ${result.weekday.trips} (${totalIn} in and ${totalOut} out)."`);

  if (result.thresholds.warnings.length > 0) {
    lines.push('');
    lines.push('WARNINGS:');
    result.thresholds.warnings.forEach(w => {
      lines.push(`"- ${w}"`);
    });
  }

  lines.push('');
  lines.push('---');
  lines.push('Report generated by ITE Trip Generation Analyzer');
  lines.push('Henrico County Department of Planning');
  lines.push('ITE Trip Generation Manual 12th Edition');

  return lines.join('\n');
}

/**
 * Generate Excel XML content
 * This creates a basic Excel-compatible XML file
 */
function generateExcelXML(result, date) {
  const xml = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
 <Styles>
  <Style ss:ID="header">
   <Font ss:Bold="1"/>
   <Interior ss:Color="#1A365D" ss:Pattern="Solid"/>
   <Font ss:Color="#FFFFFF"/>
  </Style>
  <Style ss:ID="title">
   <Font ss:Bold="1" ss:Size="14"/>
  </Style>
  <Style ss:ID="bold">
   <Font ss:Bold="1"/>
  </Style>
 </Styles>
 <Worksheet ss:Name="Trip Generation Analysis">
  <Table>
   <Row>
    <Cell ss:StyleID="title"><Data ss:Type="String">ITE TRIP GENERATION ANALYSIS REPORT</Data></Cell>
   </Row>
   <Row>
    <Cell><Data ss:Type="String">Generated: ${date.toLocaleString()}</Data></Cell>
   </Row>
   <Row></Row>
   <Row>
    <Cell ss:StyleID="bold"><Data ss:Type="String">DEVELOPMENT INFORMATION</Data></Cell>
   </Row>
   <Row>
    <Cell><Data ss:Type="String">Parcel ID:</Data></Cell>
    <Cell><Data ss:Type="String">${result.parcelId}</Data></Cell>
   </Row>
   ${result.devName ? `<Row><Cell><Data ss:Type="String">Development Name:</Data></Cell><Cell><Data ss:Type="String">${result.devName}</Data></Cell></Row>` : ''}
   <Row>
    <Cell><Data ss:Type="String">ITE Code:</Data></Cell>
    <Cell><Data ss:Type="String">${result.iteCode} - ${result.landUseName}</Data></Cell>
   </Row>
   <Row>
    <Cell><Data ss:Type="String">Size:</Data></Cell>
    <Cell><Data ss:Type="Number">${result.size}</Data></Cell>
    <Cell><Data ss:Type="String">${result.unit}</Data></Cell>
   </Row>
   <Row></Row>
   <Row>
    <Cell ss:StyleID="bold"><Data ss:Type="String">TRIP GENERATION SUMMARY</Data></Cell>
   </Row>
   <Row ss:StyleID="header">
    <Cell><Data ss:Type="String">Time Period</Data></Cell>
    <Cell><Data ss:Type="String">Total Trips</Data></Cell>
    <Cell><Data ss:Type="String">Entering</Data></Cell>
    <Cell><Data ss:Type="String">Exiting</Data></Cell>
    <Cell><Data ss:Type="String">Method</Data></Cell>
   </Row>
   <Row>
    <Cell><Data ss:Type="String">Weekday Daily</Data></Cell>
    <Cell><Data ss:Type="Number">${result.weekday.trips}</Data></Cell>
    <Cell><Data ss:Type="Number">${Math.round(result.weekday.trips/2)}</Data></Cell>
    <Cell><Data ss:Type="Number">${result.weekday.trips - Math.round(result.weekday.trips/2)}</Data></Cell>
    <Cell><Data ss:Type="String">${result.weekday.method}</Data></Cell>
   </Row>
   <Row>
    <Cell><Data ss:Type="String">AM Peak Hour</Data></Cell>
    <Cell><Data ss:Type="Number">${result.amPeak.trips}</Data></Cell>
    <Cell><Data ss:Type="Number">${result.amPeak.entering}</Data></Cell>
    <Cell><Data ss:Type="Number">${result.amPeak.exiting}</Data></Cell>
    <Cell><Data ss:Type="String">${result.amPeak.method}</Data></Cell>
   </Row>
   <Row>
    <Cell><Data ss:Type="String">PM Peak Hour</Data></Cell>
    <Cell><Data ss:Type="Number">${result.pmPeak.trips}</Data></Cell>
    <Cell><Data ss:Type="Number">${result.pmPeak.entering}</Data></Cell>
    <Cell><Data ss:Type="Number">${result.pmPeak.exiting}</Data></Cell>
    <Cell><Data ss:Type="String">${result.pmPeak.method}</Data></Cell>
   </Row>
   <Row></Row>
   <Row>
    <Cell ss:StyleID="bold"><Data ss:Type="String">THRESHOLD STATUS:</Data></Cell>
    <Cell><Data ss:Type="String">${result.thresholds.overallStatus}</Data></Cell>
   </Row>
  </Table>
 </Worksheet>
</Workbook>`;

  return xml;
}

/**
 * Generate a formatted summary table for the clipboard
 */
function generateSummaryTable(result) {
  const table = `
TRIP GENERATION SUMMARY TABLE
=============================
Parcel: ${result.parcelId}
ITE Code: ${result.iteCode} - ${result.landUseName}
Size: ${result.size} ${result.unit}

Time Period      | Total | Entering | Exiting | Method
-----------------|-------|----------|---------|------------------
Weekday Daily    | ${result.weekday.trips.toString().padStart(5)} | ${Math.round(result.weekday.trips/2).toString().padStart(8)} | ${(result.weekday.trips - Math.round(result.weekday.trips/2)).toString().padStart(7)} | ${result.weekday.method}
AM Peak Hour     | ${result.amPeak.trips.toString().padStart(5)} | ${result.amPeak.entering.toString().padStart(8)} | ${result.amPeak.exiting.toString().padStart(7)} | ${result.amPeak.method}
PM Peak Hour     | ${result.pmPeak.trips.toString().padStart(5)} | ${result.pmPeak.entering.toString().padStart(8)} | ${result.pmPeak.exiting.toString().padStart(7)} | ${result.pmPeak.method}

Threshold Status: ${result.thresholds.overallStatus}
Data Confidence: ${result.quality.confidenceLevel}
`;

  return table;
}

/**
 * Copy results to clipboard
 */
function copyToClipboard(result) {
  const text = generateSummaryTable(result);

  navigator.clipboard.writeText(text).then(() => {
    alert('Results copied to clipboard!');
  }).catch(err => {
    console.error('Failed to copy:', err);
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Results copied to clipboard!');
  });
}

// Export functions for global access
if (typeof window !== 'undefined') {
  window.exportToExcel = exportToExcel;
  window.copyToClipboard = copyToClipboard;
  window.generateSummaryTable = generateSummaryTable;
}
